---
title: "Mapping Cyclist Safety in New York City"
description: |
  Is there a relationship between bike path access and cyclist injuries? 
preview: preview.jpg
base_url: https://jasonbixon.netlify.com
author:
  - name: Jason Bixon
    url: https://jbixon13.wixsite.com/website
    affiliation: Merkle Inc.
    affiliation_url: https://merkleinc.com
date: 01-24-2019
repository_url: https://github.com/jbixon13/Radix-blog
output:
  radix::radix_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r message=FALSE, echo=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
library(scales)
library(forecast)
library(leaflet)
library(leaflet.extras)
library(rgdal)
library(sp)
library(sf)
library(htmltools)
```

```{r message=FALSE, echo=FALSE}
# read in datasets 
#MTA_bt <- read_csv('../input/nys-metropolitan-transport-authority-mta-data/hourly-traffic-on-metropolitan-transportation-authority-mta-bridges-and-tunnels-beginning-2010.csv') # MTA bridges & tunnels data
#MTA_fares <- read_csv('../input/nys-metropolitan-transport-authority-mta-data/fare-card-history-for-metropolitan-transportation-authority-mta-beginning-2010.csv')              # MTA subway fare data  
MTA_KPI <- read_csv('data/metropolitan-transportation-authority-mta-performance-indicators-per-agency-beginning-2008.csv')    # MTA KPI performance data 
NYPD <- read_csv('data/nypd-motor-vehicle-collisions.csv', col_types = list(DATE = col_character()))                                          # NYPD collision data 
```

I was inspired by this [**CityLab**](https://www.citylab.com/perspective/2018/12/new-york-city-electric-bikes-transit-crisis-de-blasio/577969/) article detailing the impending transportation crisis due to the MTA L Line shutdown. Specifically, I am interested in observing whether the shutdown contributes to an increase in cyclist injuries due to motor vehicle collisions as about [**275,000 L Line riders**](https://ny.curbed.com/2018/10/3/17925038/nyc-subway-l-train-shutdown-mitigation-alternatives) seek alternatives.  
  
[**NYC DOT**](http://web.mta.info/sandy/CanarsieTunnelRebuildingProcess.html#sdtr) has predicted about 2% of L Line riders to switch to cycling, while about 79% are predicted to move to other subway lines. I could investigate the dispersion of L Train riders to other options as a whole if data is available, but for now I will focus on cyclist safety as it's more approachable with currently available data.    

***  
### Let's start by looking at some performance metrics for the MTA subway network as a whole.   
Some of the performance metric definitions are opaque, so I'll [**specify where necessary.**](http://dashboard.mta.info/)  

```{r echo=FALSE}
# convert Period to date variable
transit <- MTA_KPI

transit$Period <- paste(transit$Period, '-01', sep = '')

transit$Period <- transit$Period %>%
  ymd()

 # filter observations to only NYC Transit (Subway and Bus)
transit <- transit %>% 
  dplyr::filter(MTA_KPI$`Agency Name` == 'NYC Transit') %>%
  group_by(Period) 
```

```{r echo=FALSE, message=FALSE, out.width='100%'}
# plot ridership 
plt.NYC.riders <- transit %>% 
  dplyr::filter(`Indicator Name` == 'Total Ridership - Subways') %>%
  ggplot(aes(x = Period, y = `Monthly Actual`)) + 
  geom_point(color = 'steelblue4', alpha = .7) + 
  geom_smooth(method = 'lm') + 
  ylab('Total Monthly Ridership - All Lines') +
  scale_y_continuous(labels = comma) +
  theme_classic()

# convert to plotly object
ggplotly(plt.NYC.riders) %>% 
  layout(title = 'Monthly ridership for the entire network has increased.',
  titlefont = list(size = 16)) %>%
  config(displayModeBar = FALSE)
```

Terminal On-Time Performance measures the percentage of trains arriving at their destination terminals as scheduled. A train is counted as on-time if it arrives at its destination early, on time, or no more than five minutes late, and has not skipped any planned stops. TOTP is a legacy metric that provides a measure of trains arriving within the standard, and not a direct measure of customer travel time, particularly since relatively few customers travel all the way to the end of a line.

```{r echo=FALSE, message=FALSE, out.width='100%'}
# plot On-Time Performance for all subway lines
plt.NYC.OTP <- transit %>% 
  dplyr::filter(`Indicator Name` == 'On-Time Performance (Terminal)') %>%
  ggplot(aes(x = Period, y = `Monthly Actual`)) + 
  geom_point(color = 'steelblue4', alpha = .7) + 
  geom_smooth(method = 'lm') + 
  ylab('Monthly On-Time Performance - All Lines') +
  theme_classic()

# convert to plotly object
ggplotly(plt.NYC.OTP) %>% 
  layout(title = 'Subway cars arriving at their destination on schedule less.', 
  titlefont = list(size = 15)) %>%
  config(displayModeBar = FALSE)
```

Wait Assessment measures how regularly the trains are spaced during peak hours. To meet the standard, the headway (time between trains) can be no greater than 25% more than the scheduled headway. This provides a percentage of trains passing the standard, but does not account for extra service operated, is not weighted to how many customers are waiting for the trains at different stations, does not distinguish between relatively minor gaps in service and major delays, and is not a true measurement of time customers spend waiting on the platform.

```{r echo=FALSE, message=FALSE, out.width='100%'}
# plot subway wait assessment for all subway lines
plt.NYC.SWA <- transit %>% 
  dplyr::filter(`Indicator Name` == 'Subway Wait Assessment') %>%
  ggplot(aes(x = Period, y = `Monthly Actual`)) + 
  geom_point(color = 'steelblue4', alpha = .7) + 
  geom_smooth(method = 'lm') +
  ylab('Subway Wait Assessment - All Lines') +
  theme_classic()

# convert to plotly object
ggplotly(plt.NYC.SWA) %>% 
  layout(title = 'Subway cars less routinely spaced during peak hours.',
  titlefont = list(size = 16)) %>%
  config(displayModeBar = FALSE) 
```

Mean Distance Between Failures (MDBF) reports how frequently car-related problems such as door failures, loss of motor power, or brake issues cause a delay of over five minutes. It is calculated by dividing the number of miles train cars run in service by the number of incidents due to car‚Äêrelated problems.

```{r echo=FALSE, message=FALSE, out.width='100%'}
# plot mean distance between failures for all subway lines 
plt.NYC.fail <- transit %>% 
  dplyr::filter(`Indicator Name` == 'Mean Distance Between Failures - Subways') %>%
  ggplot(aes(x = Period, y = `Monthly Actual`)) + 
  geom_point(color = 'steelblue4', alpha = .7) + 
  geom_smooth(method = 'lm') +
  ylab('Mean Distance Between Failures (Miles)') +
  scale_y_continuous(labels = comma) +
  theme_classic()

# convert to plotly object
ggplotly(plt.NYC.fail) %>% 
  layout(title = 'Subway cars are breaking down more frequently.',
  titlefont = list(size = 16)) %>% 
  config(displayModeBar = FALSE)
```

***
### Now let's look at some two-wheeled data.   

```{r echo=FALSE}
# convert date to a date variable
NYPD$DATE <- NYPD$DATE %>% 
  substr(start = 1, stop = 10) %>% 
  ymd()

# create summarized subset of NYPD data 
sub <- NYPD 

# summarize by week
sub <- sub %>% 
  filter(DATE > 16438) %>% 
  mutate(week = floor_date(DATE, 'weeks', week_start = 7)) %>% 
  group_by(week) %>% 
  summarize(cyclist_injuries = sum(`NUMBER OF CYCLIST INJURED`))

```

```{r echo=FALSE, message=FALSE, out.width='100%'}
# plot cyclist injuries per week 
plt.sub <- sub %>% 
  ggplot(aes(x = week, y = cyclist_injuries)) +
  geom_point(color = 'steelblue4', alpha = .7) + 
  geom_smooth(method='lm') + 
  xlab('Week') +
  ylab('Cyclist Injuries Per Week') + 
  theme_classic()

# convert to plotly object
ggplotly(plt.sub) %>% 
  layout(title = 'Cyclist injuries due to vehicle collisions increasing.',
  titlefont = list(size = 16)) %>%
  config(displayModeBar = FALSE)
```

### And now a map of cyclist injuries and deaths over the last few years.   

```{r echo=FALSE, message=FALSE, results='hide'}
# read in shapefile
bike_network <- readOGR(dsn = 'data/20180906_current_bike_network', layer = '20180906_current_bike_network')

# convert to sf and transform to web map projection  
bike_network <- st_as_sf(bike_network)
bike_network_trans <- st_transform(bike_network, 4326)

bike_network_trans <- bike_network_trans %>% 
  mutate(labs = paste0('<strong>Street: </strong>', street,
                       '<br><strong>Installed: </strong>', instdate,
    '<br><strong>Modified: </strong>', moddate,
    '<br><strong>Lanes: </strong>', lanecount,
    '<br><strong>Path Type Endpoint: </strong>', ft_facilit,
    '<br><strong>Path Type Startpoint: </strong>', tf_facilit))

labs <- as.list(bike_network_trans$labs)
```

```{r echo=FALSE, warning=FALSE, layout='l-screen-inset', fig.height=5}
# preferCanvas to improve performance with high volume of markers
map <- leaflet(data = NYPD, options = leafletOptions(minZoom = 11, maxZoom = 18, preferCanvas = TRUE)) %>%

  enableTileCaching() %>%
  
  # updateWhenZooming and updateWhenIdle to improve performance 
  addTiles(group = 'Color', options = tileOptions(updateWhenZooming = FALSE, updateWhenIdle = TRUE)) %>% 
  addProviderTiles(providers$Stamen.TonerLite, group = 'Grayscale') %>% 


  # restrict boundaries to around NYC (doesn't seem to work as expected)
  fitBounds(lng1 = min(NYPD$LONGITUDE) - 0.11, 
            lat1 = min(NYPD$LATITUDE) - 0.11,
            lng2 = max(NYPD$LONGITUDE) + 0.11, 
            lat2 = max(NYPD$LATITUDE) + 0.11) %>% 
  
  # set default view to NYC
  setView(lng = -73.94, lat = 40.729, zoom = 11) %>%  
  
  # add markers where a cyclist was injured or killed, define popup html 
  addMarkers(clusterOptions = markerClusterOptions(),
             data = NYPD[NYPD$`NUMBER OF CYCLIST INJURED` > 0 | NYPD$`NUMBER OF CYCLIST KILLED` > 0,],
             ~LONGITUDE,
             ~LATITUDE,
            popup = ~ paste0('<strong>','Date: ', '</strong>', DATE, '<br/>',
                             '<strong>', 'Time: ', '</strong>', TIME, '<br/>',
                             '<strong>', 'Injured: ', '</strong>', `NUMBER OF CYCLIST INJURED`, '<br/>',
                             '<strong>', 'Killed: ', '</strong>', `NUMBER OF CYCLIST KILLED`, '<br/>',
                             '<strong>', 'Vehicle Type 1: ', '</strong>', `VEHICLE TYPE CODE 1`, '<br/>',
                             '<strong>', 'Cause - Vehicle 1: ', '</strong>', `CONTRIBUTING FACTOR VEHICLE 1`, '<br/>', 
                             '<strong>', 'Vehicle Type 2: ', '</strong>', `VEHICLE TYPE CODE 2`, '<br/>',
                             '<strong>', 'Cause - Vehicle 2: ', '</strong>', `CONTRIBUTING FACTOR VEHICLE 2`)) %>% 
  
  # add bike path network, define labels and tooltip options for continuous paths                           
  addPolylines(data = bike_network_trans,
              color = 'darkblue',
              weight = 3,
              opacity = 1,
              smoothFactor = .5,
              label = lapply(labs, HTML),
              highlightOptions = highlightOptions(color = 'red',
                                                  weight = 4, 
                                                  bringToFront = TRUE)) %>% 
  addResetMapButton() %>% 
  
  # Add user controls to toggle groups displayed
  addLayersControl(
  baseGroups = c('Color', 'Grayscale'),
  options = layersControlOptions(collapsed = TRUE)
  ) %>%
  
  addControl("<P style='font-size:10px'>
              <B>Hint!</B>
              <br> Zoom in and click on individual points for accident details.
              <br> Hover over blue lines to see bike path details.
              </P>",
  position='bottomleft')

map
```

```{r}
# convert weekly crash data to a time-series object
ts_injuries <- ts(sub$cyclist_injuries, frequency = 52)
# plot autocorrelation function
acf(ts_injuries)
```

```{r}
arima1 <- auto.arima(ts_injuries, stepwise = FALSE, trace = FALSE)
summary(arima1)
```
***

### Planned Updates/ notes:    

This is an ongoing project that I am doing in my free time. If you have any constructive criticism please feel free to reach out, especially with suggestions about spatial regression methodology.  

* how many cyclists -- could use citibike data as a proxy  
* Analyze cyclist accidents better: conduct time-series analysis with seasonality, ARIMA, etc.   
* Update map -- add bike network (by year) and change accidents to by year grouping  
* Change drag behavior (for mobile) when [**plotly**](https://github.com/ropensci/plotly) is updated to 1.43

```{r}
# test <- NYPD %>%
#   filter(LATITUDE != is.na(TRUE)) %>% 
#   st_as_sf(coords = c('LATITUDE', 'LONGITUDE')) 
#   
# test_trans <- test %>% 
#   st_transform(crs = 4326)
# 
# dist <- st_is_within_distance(test_trans, bike_network_trans, dist = 100)
```

